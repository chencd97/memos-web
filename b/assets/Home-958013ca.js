import{al as Te,am as Ie,an as Me,ao as Le,q as W,ap as Z,aq as Ee,ar as Re,as as De,at as Fe,au as Ae,av as Be,r as u,j as e,I as C,p as ue,n as A,a2 as de,aw as Se,t as B,ax as Pe,B as Ve,ay as xe,az as ze,aA as $e,Z as me,x as be,V as Ue,aB as Oe,ah as U,Y as he,a8 as Y,U as ee,aC as He,af as _e,aD as ge,aE as qe,aF as We,aG as Ke,aH as se,aj as oe,aI as _,aJ as Ge,aK as Qe,ai as te,aL as Ye,aM as pe,aN as Xe,H as Je,aO as Ze,aP as et,aQ as tt,aR as ye,aS as st,aT as at,aU as rt,aV as ie,a5 as nt,ak as ot}from"./index-908d18d9.js";import{u as K,t as ct,M as lt}from"./Memo-897e6c44.js";import{T as it}from"./Tooltip-57a69fab.js";import{c as ut,f as G,r as dt,g as mt,M as ht}from"./MemoFilter-059516ae.js";import"./memo-b4878e41.js";var ft="[object Number]";function xt(r){return typeof r=="number"||Te(r)&&Ie(r)==ft}function gt(r){return r&&r.length?Me(r):[]}const X=()=>{const r=Le(t=>t.tag),n=W();return{state:r,getState:()=>Z.getState().tag,fetchTags:async()=>{const t={};n.isVisitorMode()&&(t.creatorId=n.getUserIdFromPath());const{data:a}=(await Ee(t)).data;Z.dispatch(Re(a))},upsertTag:async t=>{await De(t),Z.dispatch(Fe(t))},deleteTag:async t=>{await Ae(t),Z.dispatch(Be(t))}}};const pt=u.forwardRef(function(n,t){var x;const{className:a,initialContent:d,placeholder:h,fullscreen:i,onPaste:p,onContentChange:f}=n,s=u.useRef(null);u.useEffect(()=>{s.current&&d&&(s.current.value=d,f(d))},[]),u.useEffect(()=>{s.current&&!i&&y()},[(x=s.current)==null?void 0:x.value,i]);const y=()=>{s.current&&(s.current.style.height="auto",s.current.style.height=(s.current.scrollHeight??0)+"px")};u.useImperativeHandle(t,()=>({focus:()=>{var l;(l=s.current)==null||l.focus()},scrollToCursor:()=>{s.current&&(s.current.scrollTop=s.current.scrollHeight)},insertText:(l="",o="",j="")=>{if(!s.current)return;const c=s.current.selectionStart,I=s.current.selectionEnd,F=s.current.value,v=F.slice(0,c)+o+(l||F.slice(c,I))+j+F.slice(I);s.current.value=v,s.current.focus(),s.current.selectionEnd=I+o.length+l.length,f(s.current.value),y()},removeText:(l,o)=>{if(!s.current)return;const j=s.current.value,c=j.slice(0,l)+j.slice(l+o);s.current.value=c,s.current.focus(),s.current.selectionEnd=l,f(s.current.value),y()},setContent:l=>{s.current&&(s.current.value=l,s.current.focus(),f(s.current.value),y())},getContent:()=>{var l;return((l=s.current)==null?void 0:l.value)??""},getCursorPosition:()=>{var l;return((l=s.current)==null?void 0:l.selectionStart)??0},getSelectedContent:()=>{var j,c,I;const l=(j=s.current)==null?void 0:j.selectionStart,o=(c=s.current)==null?void 0:c.selectionEnd;return((I=s.current)==null?void 0:I.value.slice(l,o))??""},setCursorPosition:(l,o)=>{var c;const j=isNaN(o)?l:o;(c=s.current)==null||c.setSelectionRange(l,j)}}),[]);const S=u.useCallback(()=>{var l;f(((l=s.current)==null?void 0:l.value)??""),y()},[]);return e.jsx("div",{className:"common-editor-wrapper "+a,children:e.jsx("textarea",{className:"common-editor-inputer",rows:1,placeholder:h,ref:s,onPaste:p,onInput:S})})}),yt=r=>{const{onTagSelectorClick:n}=r,a=X().state.tags;return e.jsxs("div",{className:"action-btn relative group",children:[e.jsx(C.Hash,{className:"icon-img"}),e.jsx("div",{className:"hidden flex-row justify-start items-start flex-wrap absolute top-6 left-0 mt-1 p-1 z-1 rounded w-52 h-auto max-h-48 overflow-y-auto font-mono shadow bg-zinc-200 dark:bg-zinc-600 group-hover:flex",children:a.length>0?a.map(d=>e.jsxs("span",{className:"w-auto max-w-full truncate text-black dark:text-gray-300 cursor-pointer rounded text-sm leading-6 px-2 hover:bg-zinc-300 dark:hover:bg-zinc-700 shrink-0",onClick:()=>n(d),children:["#",d]},d)):e.jsx("p",{className:"italic text-sm ml-2",onClick:d=>d.stopPropagation(),children:"No tags found"})})]})};const jt=r=>{const{destroy:n}=r,{t}=A(),a=de(),d=K(),h=Se(),i=h.state.resources,[p,f]=u.useState({checkedArray:[]});u.useEffect(()=>{h.fetchResourceList().catch(x=>{console.error(x),B.error(x.response.data.message)}).finally(()=>{a.setFinish()})},[]),u.useEffect(()=>{const x=d.state.resourceList.map(l=>l.id);f({checkedArray:i.map(l=>x.includes(l.id))})},[i]);const s=x=>{const l=xe(x);x.type.startsWith("image")?ze(i.filter(o=>o.type.startsWith("image")).map(o=>xe(o)),i.findIndex(o=>o.id===x.id)):window.open(l)},y=x=>{const l=p.checkedArray;l[x]=!l[x],f({checkedArray:l})},S=()=>{const x=i.filter((l,o)=>p.checkedArray[o]);d.setResourceList(x),n()};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"dialog-header-container",children:[e.jsx("p",{className:"title-text",children:t("common.resources")}),e.jsx("button",{className:"btn close-btn",onClick:n,children:e.jsx(C.X,{className:"icon-img"})})]}),e.jsxs("div",{className:"dialog-content-container",children:[a.isLoading?e.jsx("div",{className:"loading-text-container",children:e.jsx("p",{className:"tip-text",children:t("resource.fetching-data")})}):e.jsxs("div",{className:"resource-table-container",children:[e.jsxs("div",{className:"fields-container",children:[e.jsx("span",{className:"field-text name-text",children:t("common.name")}),e.jsx("span",{className:"field-text type-text",children:"Type"}),e.jsx("span",{})]}),i.length===0?e.jsx("p",{className:"tip-text",children:t("resource.no-resources")}):i.map((x,l)=>e.jsxs("div",{className:"resource-container",children:[e.jsx("span",{className:"field-text name-text cursor-pointer",onClick:()=>s(x),children:x.filename}),e.jsx("span",{className:"field-text type-text",children:x.type}),e.jsx("div",{className:"flex justify-end",children:e.jsx(Pe,{checked:p.checkedArray[l],onChange:()=>y(l)})})]},x.id))]}),e.jsxs("div",{className:"flex justify-between w-full mt-2 px-2",children:[e.jsxs("span",{className:"text-sm font-mono text-gray-400 leading-8",children:[t("message.count-selected-resources"),": ",p.checkedArray.filter(x=>x).length]}),e.jsx("div",{className:"flex flex-row justify-start items-center",children:e.jsx(Ve,{onClick:S,children:t("common.confirm")})})]})]})]})};function vt(){ue({className:"resources-selector-dialog",dialogName:"resources-selector-dialog"},jt,{})}const wt=()=>{const{t:r}=A(),n=K(),t=()=>{$e({onConfirm:a=>{n.setResourceList([...n.state.resourceList,...a])}})};return e.jsxs("div",{className:"action-btn relative group",children:[e.jsx(C.FileText,{className:"icon-img"}),e.jsxs("div",{className:"hidden flex-col justify-start items-start absolute top-6 left-0 mt-1 p-1 z-1 rounded w-auto overflow-auto font-mono shadow bg-zinc-200 dark:bg-zinc-600 group-hover:flex",children:[e.jsxs("div",{className:"w-full flex text-black dark:text-gray-300 cursor-pointer rounded text-sm leading-6 px-2 truncate hover:bg-zinc-300 dark:hover:bg-zinc-700 shrink-0",onClick:t,children:[e.jsx(C.Plus,{className:"w-4 mr-1"}),e.jsx("span",{children:r("common.create")})]}),e.jsxs("div",{className:"w-full flex text-black dark:text-gray-300 cursor-pointer rounded text-sm leading-6 px-2 truncate hover:bg-zinc-300 dark:hover:bg-zinc-700 shrink-0",onClick:vt,children:[e.jsx(C.Database,{className:"w-4 mr-1"}),e.jsx("span",{children:r("editor.resources")})]})]})]})};const je={text:"common.select",value:""},Nt=r=>{const{className:n,dataSource:t,handleValueChanged:a,value:d,disabled:h,tooltipTitle:i}=r,{t:p}=A(),[f,s]=me(!1),y=u.useRef(null);let S={text:p(je.text),value:je.value};for(const o of t)if(o.value===d){S=o;break}u.useEffect(()=>{if(f){const o=j=>{var c;(c=y.current)!=null&&c.contains(j.target)||s(!1)};window.addEventListener("click",o,{capture:!0,once:!0})}},[f]);const x=o=>{a&&a(o.value),s(!1)},l=o=>{h||(o.stopPropagation(),s())};return e.jsx(it,{title:i,hidden:!h,children:e.jsxs("div",{className:`selector-wrapper ${n??""} `,ref:y,children:[e.jsxs("div",{className:`current-value-container ${f?"active":""} ${h&&"selector-disabled"}`,onClick:l,children:[h&&e.jsx("span",{className:"lock-text",children:e.jsx(C.Lock,{className:"icon-img"})}),e.jsx("span",{className:"value-text",children:S.text}),!h&&e.jsx("span",{className:"arrow-text",children:e.jsx(C.ChevronDown,{className:"icon-img"})})]}),e.jsx("div",{className:`items-wrapper ${f?"":"!hidden"}`,children:t.length>0?t.map(o=>e.jsx("div",{className:`item-container ${o.value===d?"selected":""}`,onClick:()=>{x(o)},children:o.text},o.value)):e.jsx("p",{className:"tip-text",children:p("common.null")})})]})})},Q=u.memo(Nt),St=()=>{const{t:r}=A(),n=K(),{state:{systemStatus:t}}=be(),a=n.state,d=Ue.map(i=>({value:i.value,text:r(`memo.visibility.${ct(i.value)}`)}));u.useEffect(()=>{t.disablePublicMemos&&n.setMemoVisibility("PRIVATE")},[t.disablePublicMemos,a.memoVisibility]);const h=async i=>{const p=i;n.setMemoVisibility(p)};return e.jsx(Q,{className:"visibility-selector",disabled:t.disablePublicMemos,tooltipTitle:r("memo.visibility.disabled"),value:a.memoVisibility,dataSource:d,handleValueChanged:h})},bt=r=>{const{className:n,resourceType:t}=r;let a=C.FileText;return t.includes("image")&&(a=C.Image),e.jsx(a,{className:n})},Ct=()=>{const r=K(),n=r.state,t=async a=>{r.setResourceList(n.resourceList.filter(d=>d.id!==a))};return e.jsx(e.Fragment,{children:n.resourceList&&n.resourceList.length>0&&e.jsx("div",{className:"w-full flex flex-row justify-start flex-wrap gap-2 mt-2",children:n.resourceList.map(a=>e.jsxs("div",{className:"max-w-full flex flex-row justify-start items-center flex-nowrap bg-gray-100 dark:bg-zinc-800 hover:opacity-80 px-2 py-1 rounded cursor-pointer text-gray-500",children:[e.jsx(bt,{resourceType:a.type,className:"w-4 h-auto mr-1"}),e.jsx("span",{className:"text-sm max-w-xs truncate font-mono",children:a.filename}),e.jsx(C.X,{className:"w-4 h-auto ml-1 hover:opacity-80",onClick:()=>t(a.id)})]},a.id))})})},kt=()=>{const r=K(),n=Oe(),[t,a]=u.useState([]),d=r.state.relationList;u.useEffect(()=>{(async()=>{const p=d.map(async s=>{const y=await n.getOrFetchMemoById(s.relatedMemoId);return{...s,relatedMemo:y}}),f=await Promise.all(p);a(f)})()},[d]);const h=async i=>{const p=d.filter(f=>f.relatedMemoId!==i.relatedMemoId);r.setRelationList(p)};return e.jsx(e.Fragment,{children:t.length>0&&e.jsx("div",{className:"w-full flex flex-row gap-2 mt-2 flex-wrap",children:t.map(i=>e.jsxs("div",{className:"w-auto max-w-[50%] overflow-hidden flex flex-row justify-start items-center bg-gray-100 dark:bg-zinc-800 hover:opacity-80 rounded text-sm p-1 px-2 text-gray-500 cursor-pointer",children:[e.jsx(C.Link,{className:"w-4 h-auto shrink-0"}),e.jsx("span",{className:"mx-1 max-w-full text-ellipsis font-mono whitespace-nowrap overflow-hidden",children:i.relatedMemo.content}),e.jsx(C.X,{className:"w-4 h-auto hover:opacity-80 shrink-0",onClick:()=>h(i)})]},i.relatedMemoId))})})};const ve=["- [ ] ","- [x] ","- [X] ","* ","- "],Tt=/^(\d+)\. $/,It=()=>He()??Y.get(["editorContentCache"]).editorContentCache??"",ce=r=>{Y.set({editorContentCache:r})},Mt=()=>{const{t:r,i18n:n}=A(),t=W(),a=K(),d=U(),h=he(),i=X(),p=Se(),[f,s]=u.useState({fullscreen:!1,isUploadingResource:!1,isRequesting:!1}),[y,S]=u.useState(!1),[x,l]=u.useState(!1),o=a.state,j=u.useRef(o),c=u.useRef(null),F=t.state.user.setting;u.useEffect(()=>{const{editingMemoIdCache:m}=Y.get(["editingMemoIdCache"]);m?a.setEditMemoWithId(m):a.setMemoVisibility(F.memoVisibility)},[]),u.useEffect(()=>{o.editMemoId?(h.getMemoById(o.editMemoId??ee).then(m=>{var L;m&&(J(),a.setMemoVisibility(m.visibility),a.setResourceList(m.resourceList),a.setRelationList(m.relationList),(L=c.current)==null||L.setContent(m.content??""))}),Y.set({editingMemoIdCache:o.editMemoId})):Y.remove(["editingMemoIdCache"]),j.current=o},[o.editMemoId]),u.useEffect(()=>{J()},[a.state.relationList]);const v=m=>{var T;if(!c.current)return;if((m.ctrlKey||m.metaKey)&&m.key==="Enter"){N();return}if(m.key==="Enter"&&!x){const D=c.current.getCursorPosition(),V=c.current.getContent().slice(0,D),b=_e(V.split(`
`));if(b)if(ve.includes(b)||Tt.test(b))m.preventDefault(),c.current.removeText(D-b.length,b.length);else{let O=!1;for(const H of ve)if(b.startsWith(H)){m.preventDefault(),c.current.insertText("",`
${H}`),O=!0;break}if(!O){const H=/^(\d+)\. /.exec(b);if(H){const fe=parseInt(H[1]);xt(fe)&&(m.preventDefault(),c.current.insertText("",`
${fe+1}. `))}}(T=c.current)==null||T.scrollToCursor()}return}if(m.key==="Escape"){f.fullscreen&&$();return}if(m.key==="Tab"){m.preventDefault();const D=" ".repeat(ge),V=c.current.getCursorPosition(),b=c.current.getSelectedContent();c.current.insertText(D),b&&c.current.setCursorPosition(V+ge);return}},P=async m=>{s(T=>({...T,isUploadingResource:!0}));let L;try{L=await p.createResourceWithBlob(m)}catch(T){console.error(T),B.error(typeof T=="string"?T:T.response.data.message)}return s(T=>({...T,isUploadingResource:!1})),L},w=async m=>{const L=[];for(const T of m){const D=await P(T);D&&(L.push(D),o.editMemoId&&await Ke(o.editMemoId,D.id))}if(L.length>0){const T=a.getState().resourceList;a.setResourceList([...T,...L])}},R=async m=>{m.dataTransfer&&m.dataTransfer.files.length>0&&(m.preventDefault(),await w(m.dataTransfer.files))},z=async m=>{m.clipboardData&&m.clipboardData.files.length>0&&(m.preventDefault(),await w(m.clipboardData.files))},N=async()=>{var D,V;if(f.isRequesting)return;s(b=>({...b,isRequesting:!0}));const m=((D=c.current)==null?void 0:D.getContent())??"";try{const{editMemoId:b}=a.getState();if(b&&b!==ee){const O=await h.getMemoById(b??ee);O&&await h.patchMemo({id:O.id,content:m,visibility:o.memoVisibility,resourceIdList:o.resourceList.map(H=>H.id),relationList:o.relationList}),a.clearEditMemo()}else await h.createMemo({content:m,visibility:o.memoVisibility,resourceIdList:o.resourceList.map(O=>O.id),relationList:o.relationList}),d.clearFilter()}catch(b){console.error(b),B.error(b.response.data.message)}s(b=>({...b,isRequesting:!1}));const L=qe(m),T=gt(L.filter(b=>b.parserName==="tag").map(b=>b.matchedContent.slice(1)));for(const b of T)await i.upsertTag(b);s(b=>({...b,fullscreen:!1})),a.setResourceList([]),a.setRelationList([]),ce(""),(V=c.current)==null||V.setContent(""),We()},E=()=>{var m;o.editMemoId&&(a.clearEditMemo(),a.setResourceList([]),a.setRelationList([]),(m=c.current)==null||m.setContent(""),ce(""))},M=m=>{S(m!==""),ce(m)},g=()=>{var T,D,V;if(!c.current)return;const m=c.current.getCursorPosition(),L=c.current.getContent().slice(0,m);L===""||L.endsWith(`
`)?(T=c.current)==null||T.insertText("","- [ ] "):(D=c.current)==null||D.insertText("",`
- [ ] `),(V=c.current)==null||V.scrollToCursor()},k=()=>{var T,D,V;if(!c.current)return;const m=c.current.getCursorPosition(),L=c.current.getContent().slice(0,m);L===""||L.endsWith(`
`)?(T=c.current)==null||T.insertText("","```\n","\n```"):(D=c.current)==null||D.insertText("","\n```\n","\n```"),(V=c.current)==null||V.scrollToCursor()},$=u.useCallback(()=>{s(m=>({...m,fullscreen:!m.fullscreen}))},[]),ae=u.useCallback(m=>{var L;(L=c.current)==null||L.insertText(`#${m} `)},[]),J=()=>{var m;(m=c.current)==null||m.focus()},re=()=>{},q=!!(o.editMemoId&&o.editMemoId!==ee),ne=u.useMemo(()=>({className:"memo-editor",initialContent:It(),placeholder:r("editor.placeholder"),fullscreen:f.fullscreen,onContentChange:M,onPaste:z}),[f.fullscreen,n.language]);return e.jsxs("div",{className:`memo-editor-container ${q?"edit-ing":""} ${f.fullscreen?"fullscreen":""}`,tabIndex:0,onKeyDown:v,onDrop:R,onFocus:J,onBlur:re,onCompositionStart:()=>l(!0),onCompositionEnd:()=>l(!1),children:[e.jsx(pt,{ref:c,...ne}),e.jsx("div",{className:"common-tools-wrapper",children:e.jsxs("div",{className:"common-tools-container",children:[e.jsx(yt,{onTagSelectorClick:m=>ae(m)}),e.jsx("button",{className:"action-btn",children:e.jsx(C.CheckSquare,{className:"icon-img",onClick:g})}),e.jsx("button",{className:"action-btn",children:e.jsx(C.Code,{className:"icon-img",onClick:k})}),e.jsx(wt,{}),e.jsx("button",{className:"action-btn",onClick:$,children:f.fullscreen?e.jsx(C.Minimize,{className:"icon-img"}):e.jsx(C.Maximize,{className:"icon-img"})})]})}),e.jsx(Ct,{}),e.jsx(kt,{}),e.jsxs("div",{className:"editor-footer-container",children:[e.jsx(St,{}),e.jsxs("div",{className:"buttons-container",children:[e.jsx("button",{className:`action-btn cancel-btn ${q?"":"!hidden"}`,onClick:E,children:r("editor.cancel-edit")}),e.jsx("button",{className:"action-btn confirm-btn",disabled:!(y||o.resourceList.length>0)||f.isUploadingResource||f.isRequesting,onClick:N,children:r("editor.save")})]})]})]})};const Lt=()=>{const{t:r}=A(),n=he(),t=W(),a=se(),h=U().state,{memos:i,isFetching:p}=n.state,[f,s]=u.useState(!1),y=t.getCurrentUserId(),{tag:S,duration:x,type:l,text:o,shortcutId:j,visibility:c}=h,I=j?a.getShortcutById(j):null,v=(!!(S||x&&x.from<x.to||l||o||I||c)||I?i.filter(g=>{let k=!0;if(I){const $=JSON.parse(I.payload);Array.isArray($)&&(k=ut(g,$))}if(S){const $=new Set;for(const ae of Array.from(g.content.match(new RegExp(oe,"g"))??[])){const re=ae.replace(oe,"$1").trim().split("/");let q="";for(const ne of re)q+=ne,$.add(q),q+="/"}$.has(S)||(k=!1)}return x&&x.from<x.to&&(_(g.createdTs)<x.from||_(g.createdTs)>x.to)&&(k=!1),l&&(l==="NOT_TAGGED"&&g.content.match(oe)!==null||l==="LINKED"&&(g.content.match(Ge)===null||g.content.match(Qe)===null))&&(k=!1),o&&!g.content.toLowerCase().includes(o.toLowerCase())&&(k=!1),c&&(k=g.visibility===c),k}):i).filter(g=>g.creatorId===y),P=v.filter(g=>g.pinned),w=v.filter(g=>!g.pinned),R=(g,k)=>k.createdTs-g.createdTs;P.sort(R),w.sort(R);const z=P.concat(w).filter(g=>g.rowStatus==="NORMAL"),N=u.useRef(null);u.useEffect(()=>{n.fetchMemos().then(g=>{g.length<te?s(!0):s(!1)}).catch(g=>{console.error(g),B.error(g.response.data.message)})},[y]),u.useEffect(()=>{const g=document.body.querySelector(".page-wrapper");g&&g.scrollTo(0,0)},[h]),u.useEffect(()=>{if(p||f)return;z.length<te&&E();const g=new IntersectionObserver(([k])=>{k.isIntersecting&&(E(),g.unobserve(k.target))});return N!=null&&N.current&&g.observe(N.current),()=>{N!=null&&N.current&&g.unobserve(N.current)}},[p,f,h,z.length,N]);const E=async()=>{try{(await n.fetchMemos(te,i.length)).length<te?s(!0):s(!1)}catch(g){console.error(g),B.error(g.response.data.message)}};u.useEffect(()=>(window.addEventListener("copy",M),()=>{window.removeEventListener("copy",M)}),[]);const M=g=>{var $;g.preventDefault();const k=($=document.getSelection())==null?void 0:$.toString();k!==void 0&&Ye(k.split(`

`).join(`
`))};return e.jsxs("div",{className:"memo-list-container",children:[z.map(g=>e.jsx(lt,{memo:g},`${g.id}-${g.createdTs}`)),p?e.jsx("div",{className:"status-text-container fetching-tip",children:e.jsx("p",{className:"status-text",children:r("memo.fetching-data")})}):e.jsx("div",{ref:N,className:"status-text-container",children:e.jsx("p",{className:"status-text",children:f?z.length===0?r("message.no-memos"):r("message.memos-ready"):e.jsx(e.Fragment,{children:e.jsx("span",{className:"cursor-pointer hover:text-green-600",onClick:E,children:r("memo.fetch-more")})})})})]})};const Et=r=>{const{destroy:n,shortcutId:t}=r,a=se(),[d,h]=u.useState(""),[i,p]=u.useState([]),f=de(!1),{t:s}=A();u.useEffect(()=>{if(t){const j=a.getShortcutById(t);if(j){h(j.title);const c=JSON.parse(j.payload);Array.isArray(c)&&p(c)}}},[t]);const y=j=>{const c=j.target.value;h(c)},S=async()=>{if(!d){B.error(s("shortcut-list.title-required"));return}for(const j of i)if(!j.value.value){B.error(s("shortcut-list.value-required"));return}try{t?await a.patchShortcut({id:t,title:d,payload:JSON.stringify(i)}):await a.createShortcut({title:d,payload:JSON.stringify(i)})}catch(j){console.error(j),B.error(j.response.data.message)}n()},x=()=>{if(i.length>0&&i[i.length-1].value.value===""){B(s("shortcut-list.fill-previous"));return}p([...i,mt()])},l=u.useCallback((j,c)=>{p(I=>{const F=[...I];return F[j]=c,F})},[]),o=u.useCallback(j=>{p(c=>c.filter((F,v)=>v!==j))},[]);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"dialog-header-container",children:[e.jsx("p",{className:"title-text",children:s(t?"shortcut-list.edit-shortcut":"shortcut-list.create-shortcut")}),e.jsx("button",{className:"btn close-btn",onClick:n,children:e.jsx(C.X,{})})]}),e.jsxs("div",{className:"dialog-content-container",children:[e.jsxs("div",{className:"form-item-container input-form-container",children:[e.jsx("span",{className:"normal-text",children:s("common.title")}),e.jsx("input",{className:"title-input",type:"text",placeholder:s("shortcut-list.shortcut-title"),value:d,onChange:y})]}),e.jsxs("div",{className:"form-item-container filter-form-container",children:[e.jsx("span",{className:"normal-text",children:s("common.filter")}),e.jsxs("div",{className:"filters-wrapper",children:[i.map((j,c)=>e.jsx(Rt,{index:c,filter:j,handleFilterChange:l,handleFilterRemove:o},c)),e.jsx("div",{className:"create-filter-btn",onClick:x,children:s("filter.new-filter")})]})]})]}),e.jsxs("div",{className:"dialog-footer-container",children:[e.jsx("div",{}),e.jsx("div",{className:"btns-container",children:e.jsx("button",{className:`btn-primary ${f.isLoading?"requesting":""}`,onClick:S,children:s("common.save")})})]})]})},Rt=r=>{const{index:n,filter:t,handleFilterChange:a,handleFilterRemove:d}=r,{t:h}=A(),i=X(),[p,f]=u.useState(t.value.value),s=Array.from(i.getState().tags),{type:y}=t,S=Object.values(G).map(({text:w,value:R})=>({text:h(w),value:R})),x=Object.values(G[y].operators).map(({text:w,value:R})=>({text:h(w),value:R})),l=Object.values(dt).map(({text:w,value:R})=>({text:h(w),value:R})),o=y==="TYPE"?G.TYPE.values.map(({text:w,value:R})=>({text:h(w),value:R})):y==="VISIBILITY"?G.VISIBILITY.values.map(({text:w,value:R})=>({text:h(w),value:R})):s.sort().map(w=>({text:w,value:w})),j=pe("9999-12-31T23:59");u.useEffect(()=>{if(y==="DISPLAY_TIME"){const w=pe();v(w)}else f(t.value.value)},[y]);const c=w=>{["AND","OR"].includes(w)&&a(n,{...t,relation:w})},I=w=>{if(t.type!==w){const R=Object.values(G[w].operators);a(n,{...t,type:w,value:{operator:R[0].value,value:""}})}},F=w=>{a(n,{...t,value:{...t.value,operator:w}})},v=w=>{f(w),a(n,{...t,value:{...t.value,value:w}})},P=()=>{d(n)};return e.jsxs("div",{className:"memo-filter-input-wrapper",children:[n>0?e.jsx(Q,{className:"relation-selector",dataSource:l,value:t.relation,handleValueChanged:c}):null,e.jsx(Q,{className:"type-selector",dataSource:S,value:t.type,handleValueChanged:I}),e.jsx(Q,{className:"operator-selector",dataSource:x,value:t.value.operator,handleValueChanged:F}),y==="TEXT"?e.jsx("input",{type:"text",className:"value-inputer",value:p,onChange:w=>{v(w.target.value)},placeholder:h("filter.text-placeholder")}):y==="DISPLAY_TIME"?e.jsx("input",{className:"datetime-selector",type:"datetime-local",value:p,max:j,onChange:w=>{v(w.target.value)}}):e.jsx(Q,{className:"value-selector",dataSource:o,value:p,handleValueChanged:v}),e.jsx(C.X,{className:"remove-btn",onClick:P})]})};function Ce(r){ue({className:"create-shortcut-dialog",dialogName:"create-shortcut-dialog"},Et,{shortcutId:r})}const Dt=()=>{const{t:r}=A(),n=U(),t=se(),a=n.state,d=t.state.shortcuts,h=de(),i=d.filter(s=>s.rowStatus==="ARCHIVED").sort((s,y)=>_(y.createdTs)-_(s.createdTs)),p=d.filter(s=>s.rowStatus==="NORMAL").sort((s,y)=>_(y.createdTs)-_(s.createdTs)),f=i.concat(p);return u.useEffect(()=>{t.getMyAllShortcuts().catch(()=>{}).finally(()=>{h.setFinish()})},[]),e.jsxs("div",{className:"flex flex-col justify-start items-start w-full mt-2 h-auto shrink-0 flex-nowrap hide-scrollbar",children:[e.jsxs("div",{className:"flex flex-row justify-start items-center w-full px-4",children:[e.jsx("span",{className:"text-sm leading-6 font-mono text-gray-400",children:r("common.shortcuts")}),e.jsx("button",{className:"flex flex-col justify-center items-center w-5 h-5 bg-gray-200 dark:bg-zinc-700 rounded ml-2 hover:shadow",onClick:()=>Ce(),children:e.jsx(C.Plus,{className:"w-4 h-4 text-gray-400"})})]}),e.jsx("div",{className:"flex flex-col justify-start items-start relative w-full h-auto flex-nowrap mb-2",children:f.map(s=>e.jsx(Ft,{shortcut:s,isActive:s.id===Number(a==null?void 0:a.shortcutId)},s.id))})]})},Ft=r=>{const{shortcut:n,isActive:t}=r,{t:a}=A(),d=U(),h=se(),[i,p]=me(!1),f=()=>{t?d.setMemoShortcut(void 0):d.setMemoShortcut(n.id)},s=async l=>{if(l.stopPropagation(),i)try{await h.deleteShortcutById(n.id),d.getState().shortcutId===n.id&&d.setMemoShortcut(void 0)}catch(o){console.error(o),B.error(o.response.data.message)}else p()},y=l=>{l.stopPropagation(),Ce(n.id)},S=async l=>{l.stopPropagation();try{const o={id:n.id,rowStatus:n.rowStatus==="ARCHIVED"?"NORMAL":"ARCHIVED"};await h.patchShortcut(o)}catch{}},x=()=>{p(!1)};return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"relative group flex flex-row justify-between items-center w-full h-10 py-0 px-4 mt-px first:mt-2 rounded-lg text-base cursor-pointer select-none shrink-0 hover:bg-white dark:hover:bg-zinc-700",onClick:f,children:[e.jsx("div",{className:`flex flex-row justify-start items-center truncate shrink leading-5 mr-1 text-black dark:text-gray-200 ${t&&"text-green-600"}`,children:e.jsx("span",{className:"truncate",children:n.title})}),e.jsxs("div",{className:"flex-row justify-end items-center hidden group/btns group-hover:flex shrink-0",children:[e.jsx("span",{className:"flex flex-row justify-center items-center toggle-btn",children:e.jsx(C.MoreHorizontal,{className:"w-4 h-auto"})}),e.jsx("div",{className:"absolute top-4 right-0 flex-col justify-start items-start w-auto h-auto px-4 pt-3 hidden group-hover/btns:flex z-1",children:e.jsxs("div",{className:"flex flex-col justify-start items-start w-24 h-auto p-1 whitespace-nowrap rounded-md bg-white dark:bg-zinc-700 shadow",children:[e.jsx("span",{className:"w-full text-sm leading-6 py-1 px-3 rounded text-left dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-zinc-800",onClick:S,children:n.rowStatus==="ARCHIVED"?a("common.unpin"):a("common.pin")}),e.jsx("span",{className:"w-full text-sm leading-6 py-1 px-3 rounded text-left dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-zinc-800",onClick:y,children:a("common.edit")}),e.jsxs("span",{className:`w-full text-sm leading-6 py-1 px-3 rounded text-left dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-zinc-800 text-orange-600 ${i&&"font-black"}`,onClick:s,onMouseLeave:x,children:[a("common.delete"),i?"!":""]})]})})]})]})})},le=r=>{const n=Ze(`#${r}`,et.regexp);return!(!n||n[1]!==r)},At=r=>{const{destroy:n}=r,t=X(),{t:a}=A(),[d,h]=u.useState(""),[i,p]=u.useState([]),[f,s]=u.useState(!1),y=t.state.tags,S=i.filter(v=>!y.includes(v));u.useEffect(()=>{Xe().then(({data:v})=>{p(v.data.filter(P=>le(P)))})},[y]);const x=v=>{v.key==="Enter"&&c()},l=v=>{const P=v.target.value;h(P.trim())},o=async v=>{await t.upsertTag(v)},j=()=>{s(v=>!v)},c=async()=>{if(!le(d)){B.error("Invalid tag name");return}try{await t.upsertTag(d),h("")}catch(v){console.error(v),B.error(v.response.data.message)}},I=async v=>{await t.deleteTag(v)},F=async()=>{for(const v of i)le(v)&&await t.upsertTag(v)};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"dialog-header-container",children:[e.jsx("p",{className:"title-text",children:a("tag-list.create-tag")}),e.jsx("button",{className:"btn close-btn",onClick:()=>n(),children:e.jsx(C.X,{})})]}),e.jsxs("div",{className:"dialog-content-container !w-80",children:[e.jsx(Je,{className:"mb-2",size:"md",placeholder:a("tag-list.tag-name"),value:d,onChange:l,onKeyDown:x,fullWidth:!0,startDecorator:e.jsx(C.Hash,{className:"w-4 h-auto"}),endDecorator:e.jsx(C.Check,{onClick:c,className:"w-4 h-auto cursor-pointer hover:opacity-80"})}),y.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"w-full mt-2 mb-1 text-sm text-gray-400",children:a("tag-list.all-tags")}),e.jsx("div",{className:"w-full flex flex-row justify-start items-start flex-wrap",children:Array.from(y).sort().map(v=>e.jsxs("span",{className:"max-w-[120px] text-sm mr-2 mt-1 font-mono cursor-pointer truncate dark:text-gray-300 hover:opacity-60 hover:line-through",onClick:()=>I(v),children:["#",v]},v))})]}),S.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-4 mb-1 text-sm w-full flex flex-row justify-start items-center",children:[e.jsx("span",{className:"text-gray-400",children:"Tag suggestions"}),e.jsx("button",{className:"btn-normal ml-2 px-2 py-0 leading-6 font-mono",onClick:j,children:f?"hide":"show"})]}),f&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full flex flex-row justify-start items-start flex-wrap",children:S.map(v=>e.jsxs("span",{className:"max-w-[120px] text-sm mr-2 mt-1 font-mono cursor-pointer truncate dark:text-gray-300 hover:opacity-60",onClick:()=>o(v),children:["#",v]},v))}),e.jsx("button",{className:"btn-normal mt-2 px-2 py-0 leading-6 font-mono",onClick:F,children:"Save all"})]})]})]})]})};function Bt(){ue({className:"create-tag-dialog",dialogName:"create-tag-dialog"},At)}const Pt=()=>{const{t:r}=A(),n=U(),t=X(),a=t.state.tags,d=n.state,[h,i]=u.useState([]);return u.useEffect(()=>{t.fetchTags()},[]),u.useEffect(()=>{const p=Array.from(a).sort(),f={subTags:[]};for(const s of p){const y=s.split("/");let S=f,x="";for(let l=0;l<y.length;l++){const o=y[l];l===0?x+=o:x+="/"+o;let j=null;for(const c of S.subTags)if(c.text===x){j=c;break}j||(j={key:o,text:x,subTags:[]},S.subTags.push(j)),S=j}}i(f.subTags)},[a]),e.jsxs("div",{className:"flex flex-col justify-start items-start w-full mt-2 h-auto shrink-0 flex-nowrap hide-scrollbar",children:[e.jsxs("div",{className:"flex flex-row justify-start items-center w-full px-4",children:[e.jsx("span",{className:"text-sm leading-6 font-mono text-gray-400",children:r("common.tags")}),e.jsx("button",{onClick:()=>Bt(),className:"flex flex-col justify-center items-center w-5 h-5 bg-gray-200 dark:bg-zinc-700 rounded ml-2 hover:shadow",children:e.jsx(C.Plus,{className:"w-4 h-4 text-gray-400"})})]}),e.jsx("div",{className:"flex flex-col justify-start items-start relative w-full h-auto flex-nowrap mt-2 mb-2",children:h.map((p,f)=>e.jsx(ke,{tag:p,tagQuery:d.tag},p.text+"-"+f))})]})},ke=r=>{const n=U(),{tag:t,tagQuery:a}=r,d=a===t.text,h=t.subTags.length>0,[i,p]=me(!1),f=()=>{d?n.setTagFilter(void 0):n.setTagFilter(t.text)},s=y=>{y.stopPropagation(),p()};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative group flex flex-row justify-between items-center w-full h-10 py-0 px-4 mt-px first:mt-1 rounded-lg text-base cursor-pointer select-none shrink-0 hover:opacity-60",onClick:f,children:[e.jsxs("div",{className:`flex flex-row justify-start items-center truncate shrink leading-5 mr-1 text-black dark:text-gray-200 ${d&&"text-green-600"}`,children:[e.jsx("span",{className:"block w-4 shrink-0",children:"#"}),e.jsx("span",{className:"truncate",children:t.key})]}),e.jsx("div",{className:"flex flex-row justify-end items-center",children:h?e.jsx("span",{className:`flex flex-row justify-center items-center w-6 h-6 shrink-0 transition-all rotate-0 ${i&&"rotate-90"}`,onClick:s,children:e.jsx(C.ChevronRight,{className:"w-5 h-5 opacity-80 dark:text-gray-400"})}):null})]}),h?e.jsx("div",{className:`w-full flex flex-col justify-start items-start h-auto ml-5 pl-1 border-l-2 border-l-gray-200 dark:border-l-gray-400 ${!i&&"!hidden"}`,children:t.subTags.map((y,S)=>e.jsx(ke,{tag:y,tagQuery:a},y.text+"-"+S))}):null]})},Vt=()=>{const{t:r}=A(),n=U(),[t,a]=u.useState(""),d=u.useRef(null);u.useEffect(()=>{const i=n.getState().text;a(i===void 0?"":i)},[n.state.text]),tt(()=>{n.setTextFilter(t.length===0?void 0:t)},200,[t]);const h=i=>{const p=i.currentTarget.value;a(p)};return e.jsxs("div",{className:"w-full h-9 flex flex-row justify-start items-center py-2 px-3 rounded-md bg-gray-200 dark:bg-zinc-700",children:[e.jsx(C.Search,{className:"w-4 h-auto opacity-30 dark:text-gray-200"}),e.jsx("input",{className:"flex ml-2 w-24 grow text-sm outline-none bg-transparent dark:text-gray-200",type:"text",placeholder:r("memo.search-placeholder"),ref:d,value:t,onChange:h})]})};const we={width:10,height:7},Ne=(r,n)=>{const t=[];for(let a=1;a<=r;a++)t.push({timestamp:n+ie*a,count:0});return t},zt=()=>{const{t:r}=A(),n=U(),t=W(),a=he(),d=ye(Date.now()),h=new Date(d).getDay()+1,i=new Array(7-h).fill(0),p=(we.width-1)*we.height+h,f=d-p*ie,s=a.state.memos,[y,S]=u.useState(0),[x,l]=u.useState(0),[o,j]=u.useState(Ne(p,f)),[c,I]=u.useState(null),F=u.useRef(null),v=t.getCurrentUserId();u.useEffect(()=>{t.getUserById(v).then(N=>{N&&l(Math.ceil((Date.now()-_(N.createdTs))/1e3/3600/24))})},[v]),u.useEffect(()=>{st(v).then(({data:{data:N}})=>{S(N.length);const E=Ne(p,f);for(const M of N){const g=(ye(M*1e3)-f)/864e5-1;if(g>=0){const k=+g.toFixed(0);E[k].count+=1}}j([...E])}).catch(N=>{console.error(N)})},[s.length,v]);const P=u.useCallback((N,E)=>{const M=document.createElement("div");M.className="usage-detail-container pop-up";const g=at(N.target);M.style.left=g.left+"px",M.style.top=g.top-2+"px";const k={amount:E.count,date:rt(E.timestamp)};M.innerHTML=E.count===1?r("heatmap.memo-on",k):r("heatmap.memos-on",k),document.body.appendChild(M),M.offsetLeft-M.clientWidth/2<0&&(M.style.left=g.left+M.clientWidth*.4+"px",M.className+=" offset-left")},[]),w=u.useCallback(()=>{document.body.querySelectorAll("div.usage-detail-container.pop-up").forEach(N=>N.remove())},[]),R=u.useCallback(N=>{var E;((E=n.getState().duration)==null?void 0:E.from)===N.timestamp?(n.setFromAndToFilter(),I(null)):N.count>0&&(n.setFromAndToFilter(N.timestamp,N.timestamp+ie),I(N))},[]),z={amount:y,period:"",date:""};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"usage-heat-map-wrapper",ref:F,children:[e.jsxs("div",{className:"usage-heat-map",children:[o.map((N,E)=>{const M=N.count,g=M<=0?"":M<=1?"stat-day-l1-bg":M<=2?"stat-day-l2-bg":M<=4?"stat-day-l3-bg":"stat-day-l4-bg";return e.jsx("div",{className:"stat-wrapper",onMouseEnter:k=>P(k,N),onMouseLeave:w,onClick:()=>R(N),children:e.jsx("span",{className:`stat-container ${g} ${c===N?"current":""} ${d===N.timestamp?"today":""}`})},E)}),i.map((N,E)=>e.jsx("div",{className:"stat-wrapper",children:e.jsx("span",{className:"stat-container null"})},E))]}),e.jsxs("div",{className:"day-tip-text-container",children:[e.jsx("span",{className:"tip-text",children:r("days.sun")}),e.jsx("span",{className:"tip-text"}),e.jsx("span",{className:"tip-text",children:r("days.tue")}),e.jsx("span",{className:"tip-text"}),e.jsx("span",{className:"tip-text",children:r("days.thu")}),e.jsx("span",{className:"tip-text"}),e.jsx("span",{className:"tip-text",children:r("days.sat")})]})]}),e.jsxs("p",{className:"w-full pl-4 text-xs -mt-2 mb-3 text-gray-400 dark:text-zinc-400",children:[e.jsxs("span",{className:"font-medium text-gray-500 dark:text-zinc-300 number",children:[y," "]}),r(y===1?"heatmap.memo-in":"heatmap.memos-in",z)," ",e.jsxs("span",{className:"font-medium text-gray-500 dark:text-zinc-300",children:[x," "]}),r(x===1?"heatmap.day":"heatmap.days",z)]})]})},$t=()=>{const r=nt(),n=W(),t=r.state.showHomeSidebar;return e.jsxs("div",{className:`fixed md:sticky top-0 left-0 w-full md:w-56 h-full shrink-0 pointer-events-none md:pointer-events-auto z-10 ${t&&"pointer-events-auto"}`,children:[e.jsx("div",{className:`fixed top-0 left-0 w-full h-full bg-black opacity-0 pointer-events-none transition-opacity duration-300 md:!hidden ${t&&"opacity-60 pointer-events-auto"}`,onClick:()=>r.setHomeSidebarStatus(!1)}),e.jsxs("aside",{className:`absolute md:relative top-0 right-0 w-56 pr-2 md:w-full h-full max-h-screen overflow-auto hide-scrollbar flex flex-col justify-start items-start py-4 z-30 bg-zinc-100 dark:bg-zinc-800 md:bg-transparent md:shadow-none transition-all duration-300 translate-x-full md:translate-x-0 ${t&&"!translate-x-0 shadow-2xl"}`,children:[e.jsx("div",{className:"px-4 pr-8 mb-4 w-full",children:e.jsx(Vt,{})}),e.jsx(zt,{}),!n.isVisitorMode()&&e.jsxs(e.Fragment,{children:[e.jsx(Dt,{}),e.jsx(Pt,{})]})]})]})};function Wt(){const{t:r}=A(),n=be(),t=W(),a=t.state.user;return u.useEffect(()=>{const d=t.getCurrentUserId();t.getUserById(d).then(h=>{if(!h){B.error(r("message.user-not-found"));return}})},[t.getCurrentUserId()]),u.useEffect(()=>{a!=null&&a.setting.locale&&n.setLocale(a.setting.locale)},[a==null?void 0:a.setting.locale]),e.jsxs("div",{className:"w-full flex flex-row justify-start items-start",children:[e.jsxs("div",{className:"flex-grow shrink w-auto max-w-2xl px-4 sm:px-2 sm:pt-4",children:[e.jsx(ot,{}),e.jsxs("div",{className:"w-full h-auto flex flex-col justify-start items-start bg-zinc-100 dark:bg-zinc-800 rounded-lg",children:[!t.isVisitorMode()&&e.jsx(Mt,{}),e.jsx(ht,{})]}),e.jsx(Lt,{})]}),e.jsx($t,{})]})}export{Wt as default};
